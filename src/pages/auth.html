<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KeepRolling - Authentication</title>
    <link rel="icon" type="image/png" href="../assets/images/KeepRolling_Black.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/auth.css">
    <script src="https://accounts.google.com/gsi/client" async></script>
</head>
<body>
    <canvas id="starfield"></canvas>
    <div class="purple-orb orb-1"></div>
    <div class="purple-orb orb-2"></div>

    <div class="auth-container">
        <!-- Close Button -->
        <button class="close-btn">
            <i class="fas fa-times"></i>
        </button>

        <!-- Logo -->
        <div class="auth-logo">
            <img src="../assets/images/KeepRolling_White.png" alt="KeepRolling">
        </div>

        <!-- Auth Forms Container -->
        <div class="auth-forms">
            <!-- Username Setup Form (initially hidden) -->
            <form id="usernameSetupForm" class="auth-form" style="display: none;">
                <h2>Choose Your Username</h2>
                <p class="form-subtitle">Pick a unique username for the leaderboard</p>
                
                <div class="form-group">
                    <div class="input-icon">
                        <i class="fas fa-user"></i>
                        <input type="text" id="username" placeholder="Enter username" required
                               pattern="[a-zA-Z0-9_]{3,20}">
                    </div>
                </div>

                <div class="requirements">
                    <h3>Username Requirements:</h3>
                    <ul>
                        <li><i class="fas fa-check"></i> 3-20 characters long</li>
                        <li><i class="fas fa-check"></i> Letters, numbers, and underscores only</li>
                        <li><i class="fas fa-check"></i> Must be unique</li>
                        <li><i class="fas fa-times"></i> No inappropriate words</li>
                    </ul>
                </div>

                <div id="usernameError" class="error-message" style="display: none;"></div>

                <button type="submit" class="auth-button">
                    <span>Set Username</span>
                    <i class="fas fa-arrow-right"></i>
                </button>
            </form>

            <!-- Login Form -->
            <form id="loginForm" class="auth-form active">
                <h2>Welcome Back!</h2>
                <p class="form-subtitle">Log in to your account to continue playing</p>
                
                <div class="form-group">
                    <div class="input-icon">
                        <i class="fas fa-envelope"></i>
                        <input type="email" placeholder="Email" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <div class="input-icon">
                        <i class="fas fa-lock"></i>
                        <input type="password" placeholder="Password" required>
                        <button type="button" class="toggle-password">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>

                <div class="form-options">
                    <label class="remember-me">
                        <input type="checkbox">
                        <span>Remember me</span>
                    </label>
                    <a href="#" class="forgot-password">Forgot Password?</a>
                </div>

                <button type="submit" class="auth-button">
                    <span>Log In</span>
                    <i class="fas fa-arrow-right"></i>
                </button>

                <div class="social-auth">
                    <p>Or continue with</p>
                    <div class="social-buttons">
                        <div id="g_id_onload"
                             data-client_id="397343034720-6rac7k12okii11u2m8h1kou3a3q1gtp1.apps.googleusercontent.com"
                             data-context="signin"
                             data-ux_mode="popup"
                             data-callback="handleCredentialResponse"
                             data-auto_prompt="false">
                        </div>
                        <div class="g_id_signin"
                             data-type="standard"
                             data-shape="rectangular"
                             data-theme="outline"
                             data-text="signin_with"
                             data-size="large"
                             data-logo_alignment="left">
                        </div>
                        <button type="button" class="social-btn facebook">
                            <i class="fab fa-facebook-f"></i>
                        </button>
                        <button type="button" class="social-btn twitter">
                            <i class="fab fa-twitter"></i>
                        </button>
                    </div>
                </div>

                <p class="switch-form-text">
                    Don't have an account? 
                    <a href="#" class="switch-form" data-form="register">Sign Up</a>
                </p>
            </form>

            <!-- Register Form -->
            <form id="registerForm" class="auth-form">
                <h2>Create Account</h2>
                <p class="form-subtitle">Join us and start playing risk-free</p>
                
                <div class="form-group">
                    <div class="input-icon">
                        <i class="fas fa-user"></i>
                        <input type="text" placeholder="Username" required>
                    </div>
                </div>

                <div class="form-group">
                    <div class="input-icon">
                        <i class="fas fa-envelope"></i>
                        <input type="email" placeholder="Email" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <div class="input-icon">
                        <i class="fas fa-lock"></i>
                        <input type="password" placeholder="Password" required>
                        <button type="button" class="toggle-password">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <div class="input-icon">
                        <i class="fas fa-lock"></i>
                        <input type="password" placeholder="Confirm Password" required>
                        <button type="button" class="toggle-password">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>

                <div class="form-options">
                    <label class="terms">
                        <input type="checkbox" required>
                        <span>I agree to the <a href="#">Terms</a> and <a href="#">Privacy Policy</a></span>
                    </label>
                </div>

                <button type="submit" class="auth-button">
                    <span>Create Account</span>
                    <i class="fas fa-arrow-right"></i>
                </button>

                <div class="social-auth">
                    <p>Or sign up with</p>
                    <div class="social-buttons">
                        <div class="g_id_signin"
                             data-type="standard"
                             data-shape="rectangular"
                             data-theme="outline"
                             data-text="signup_with"
                             data-size="large"
                             data-logo_alignment="left">
                        </div>
                        <button type="button" class="social-btn facebook">
                            <i class="fab fa-facebook-f"></i>
                        </button>
                        <button type="button" class="social-btn twitter">
                            <i class="fab fa-twitter"></i>
                        </button>
                    </div>
                </div>

                <p class="switch-form-text">
                    Already have an account? 
                    <a href="#" class="switch-form" data-form="login">Log In</a>
                </p>
            </form>
        </div>
    </div>

    <script>
        // Initialize starfield animation
        function initStarfield() {
            const canvas = document.getElementById('starfield');
            const ctx = canvas.getContext('2d');
            
            function resizeCanvas() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            class Star {
                constructor() {
                    this.reset();
                }
                
                reset() {
                    this.x = (Math.random() - 0.5) * canvas.width * 2;
                    this.y = (Math.random() - 0.5) * canvas.height * 2;
                    this.z = Math.random() * 2000;
                    
                    this.px = this.x;
                    this.py = this.y;
                    this.pz = this.z;
                }
                
                update(speed) {
                    this.pz = this.z;
                    this.z -= speed;
                    
                    if (this.z <= 1) {
                        this.reset();
                    }
                    
                    this.px = this.x;
                    this.py = this.y;
                }
                
                draw() {
                    const sx = (this.x / this.z) * canvas.width + canvas.width / 2;
                    const sy = (this.y / this.z) * canvas.height + canvas.height / 2;
                    const px = (this.x / this.pz) * canvas.width + canvas.width / 2;
                    const py = (this.y / this.pz) * canvas.height + canvas.height / 2;
                    
                    ctx.beginPath();
                    ctx.moveTo(px, py);
                    ctx.lineTo(sx, sy);
                    ctx.stroke();
                }
            }
            
            const stars = Array.from({ length: 400 }, () => new Star());
            const colors = ['#8C3DCE', '#B76EFF', '#FFFFFF', '#FFD700'];
            
            function animate() {
                ctx.fillStyle = 'rgba(15, 15, 26, 0.15)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                stars.forEach(star => {
                    ctx.strokeStyle = colors[Math.floor(Math.random() * colors.length)];
                    ctx.lineWidth = Math.random() * 2 + 0.5;
                    star.update(3);
                    star.draw();
                });
                
                requestAnimationFrame(animate);
            }
            
            animate();
        }

        // Form handling
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize starfield first
            initStarfield();

            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const authForms = document.querySelector('.auth-forms');
            
            // Set initial height based on active form
            function updateFormsHeight() {
                const activeForm = document.querySelector('.auth-form.active');
                if (activeForm) {
                    authForms.style.height = `${activeForm.offsetHeight}px`;
                }
            }
            
            // Check URL parameters for initial form display
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode');
            
            if (mode === 'register') {
                registerForm.classList.add('active');
                loginForm.classList.remove('active');
            } else {
                loginForm.classList.add('active');
                registerForm.classList.remove('active');
            }
            
            // Update height after initial form is set
            updateFormsHeight();
            
            // Switch between forms
            document.querySelectorAll('.switch-form').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetForm = link.getAttribute('data-form');
                    
                    if (targetForm === 'login') {
                        loginForm.classList.add('active');
                        registerForm.classList.remove('active');
                        history.pushState({}, '', '?mode=login');
                    } else {
                        registerForm.classList.add('active');
                        loginForm.classList.remove('active');
                        history.pushState({}, '', '?mode=register');
                    }
                    
                    // Update height after switching forms
                    updateFormsHeight();
                });
            });

            // Toggle password visibility
            document.querySelectorAll('.toggle-password').forEach(button => {
                button.addEventListener('click', () => {
                    const input = button.parentElement.querySelector('input');
                    const icon = button.querySelector('i');
                    
                    if (input.type === 'password') {
                        input.type = 'text';
                        icon.classList.remove('fa-eye');
                        icon.classList.add('fa-eye-slash');
                    } else {
                        input.type = 'password';
                        icon.classList.remove('fa-eye-slash');
                        icon.classList.add('fa-eye');
                    }
                });
            });

            // Close button
            document.querySelector('.close-btn').addEventListener('click', () => {
                window.location.href = '../common/index.html';
            });

            // Handle form submissions
            [loginForm, registerForm].forEach(form => {
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    // Add your form submission logic here
                    console.log('Form submitted:', form.id);
                });
            });

            // Update forms height on window resize
            window.addEventListener('resize', updateFormsHeight);

            // Initialize Google Sign-In
            google.accounts.id.initialize({
                client_id: '397343034720-6rac7k12okii11u2m8h1kou3a3q1gtp1.apps.googleusercontent.com',
                callback: handleCredentialResponse,
                auto_select: false,
                cancel_on_tap_outside: true
            });

            // Render the button
            google.accounts.id.renderButton(
                document.querySelector('.g_id_signin'),
                { theme: 'outline', size: 'large' }
            );
        });

        // Update the style for Google Sign-In buttons
        const style = document.createElement('style');
        style.textContent = `
            .social-buttons {
                display: flex;
                justify-content: center;
                gap: 10px;
                margin-top: 15px;
                align-items: center;
            }

            .g_id_signin {
                width: auto !important;
                margin-right: 10px;
            }

            .social-buttons iframe {
                margin: 0 !important;
            }
        `;
        document.head.appendChild(style);

        function handleCredentialResponse(response) {
            console.log("Google response received:", response);
            
            if (!response.credential) {
                console.error("No credential received");
                return;
            }

            fetch('http://localhost:3000/auth/google/callback', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    id_token: response.credential
                }),
                credentials: 'include'
            })
            .then(res => {
                console.log("Server response status:", res.status);
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                return res.json();
            })
            .then(data => {
                console.log("Vollständige Benutzerdaten vom Server:", data);
                if (data.success) {
                    // Store user info in localStorage
                    localStorage.setItem('user', JSON.stringify(data.user));
                    
                    if (data.requireUsername) {
                        // Show username setup form instead of redirecting
                        document.querySelectorAll('.auth-form').forEach(form => form.style.display = 'none');
                        document.getElementById('usernameSetupForm').style.display = 'block';
                        updateFormsHeight();
                    } else {
                        console.log("Redirecting to main page...");
                        window.location.href = '../common/index.html';
                    }
                } else {
                    console.error('Login failed:', data.message);
                    alert('Login failed: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error during login:', error);
                alert('An error occurred during login. Please try again.');
            });
        }

        // Add username setup form handling
        document.getElementById('usernameSetupForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const errorElement = document.getElementById('usernameError');

            try {
                const response = await fetch('http://localhost:3000/auth/set-username', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username }),
                    credentials: 'include'
                });

                const data = await response.json();

                if (data.success) {
                    // Update stored user data
                    localStorage.setItem('user', JSON.stringify(data.user));
                    // Redirect to main page
                    window.location.href = '../common/index.html';
                } else {
                    errorElement.textContent = data.message;
                    errorElement.style.display = 'block';
                }
            } catch (error) {
                console.error('Error setting username:', error);
                errorElement.textContent = 'An error occurred. Please try again.';
                errorElement.style.display = 'block';
            }
        });

        // Check if we're in login mode
        window.onload = function() {
            // Initialize Google Sign-In
            google.accounts.id.initialize({
                client_id: '397343034720-6rac7k12okii11u2m8h1kou3a3q1gtp1.apps.googleusercontent.com',
                callback: handleCredentialResponse,
                auto_select: false,
                cancel_on_tap_outside: true
            });

            // Check URL parameters for form display
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode');
            
            if (mode === 'login') {
                document.querySelector('.auth-container').style.display = 'block';
            }
        };

        async function logout() {
            try {
                console.log("Logging out...");
                // Clear server session
                await fetch('http://localhost:3000/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                
                // Clear local storage
                localStorage.removeItem('user');
                
                // Clear Google session
                google.accounts.id.disableAutoSelect();
                
                console.log("Logout successful, reloading page...");
                // Reload page
                window.location.href = 'auth.html?mode=login';
            } catch (error) {
                console.error('Logout error:', error);
                alert('Error during logout. Please try again.');
            }
        }

        // Add a global function for the logout button
        window.logout = logout;
    </script>

    <style>
        .requirements {
            text-align: left;
            margin: 20px 0;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
        }

        .requirements ul {
            list-style-type: none;
            padding-left: 0;
        }

        .requirements li {
            margin: 5px 0;
        }

        .requirements li i {
            margin-right: 8px;
        }

        .error-message {
            color: #ff6b6b;
            margin-top: 10px;
            font-size: 14px;
            text-align: center;
        }
    </style>
</body>
</html> 